name: 'Sync Fork with Upstream (Exclude main.yml)'

on:
  schedule:
    - cron: '0 1 * * *'  # 每天 UTC 时间 01:00 自动运行
  workflow_dispatch:  # 手动触发

jobs:
  sync_with_upstream:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout this repository
      uses: actions/checkout@v3
      with:
        persist-credentials: false  # 使用 GITHUB_TOKEN 手动管理认证
        fetch-depth: 0  # 确保拉取所有历史记录

    - name: Set up Git config
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"

    - name: Add upstream repository
      run: |
        git remote add upstream https://github.com/kimwang1978/collect-tv-txt.git  # 替换为上游仓库地址
        git fetch upstream

    - name: Create a backup branch
      run: |
        git checkout -b backup-branch

    - name: Merge upstream changes
      run: |
        git checkout main
        git merge upstream/main --no-commit --no-ff || { echo "Merge conflicts detected, stopping workflow."; exit 1; }

    - name: Restore local version of main.yml
      run: |
        git restore --source=HEAD --staged --worktree .github/workflows/main.yml  # 恢复本地版本的 main.yml

    - name: Commit the merge
      run: |
        git commit -m "Merge upstream changes but keep local main.yml" || echo "Nothing to commit"

    - name: Push changes to origin
      run: |
        git push origin main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup backup branch
      run: |
        git branch -D backup-branch  # 删除备份分支
